<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
  <title>ask.report</title>
  <style>
    :root{--fg:#eaeaea;--bg:#0b0b0f;--accent:#7ae3ff;--glow:#7ae3ff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    canvas{position:fixed;inset:0;display:block;width:100%;height:100%;touch-action:none}

    /* Top bar */
    .overlay{position:fixed;top:16px;left:18px;right:18px;display:flex;justify-content:space-between;align-items:center;pointer-events:none;z-index:20}
    .brand{letter-spacing:.08em;font-weight:700;color:var(--fg);text-transform:lowercase;position:relative;pointer-events:auto;cursor:pointer;user-select:none;padding:4px 10px;border-radius:999px;display:flex;align-items:center;gap:6px;border:1px solid #ffffff20;background:#00000040;backdrop-filter:blur(6px)}
    .brand::before{content:"";position:absolute;inset:-18px;filter:blur(28px);border-radius:999px;background:radial-gradient(260px 140px at var(--brand-glow-x,50%) var(--brand-glow-y,50%), var(--glow) 0%, transparent 72%);opacity:.95;pointer-events:none;animation:brandPulse 2.2s ease-in-out infinite alternate}
    @keyframes brandPulse{0%{opacity:.55}100%{opacity:1}}
    .brand svg{height:28px;width:28px;min-width:28px;flex:0 0 auto;display:block;color:#e31e24;filter:drop-shadow(0 0 8px var(--glow))}
    .brand.loose{position:fixed;z-index:9999;pointer-events:auto}
    .wordmark{margin-left:2px}

    .right{display:flex;gap:8px;pointer-events:auto}
    .hamburger{display:none;flex-direction:column;gap:4px;padding:6px 10px;border-radius:999px;background:#00000060;cursor:pointer;border:1px solid #ffffff20;pointer-events:auto;z-index:1001;}
    .hamburger div{width:20px;height:2px;background:var(--fg)}
    .menu{display:none;}

    @media(max-width:820px){
      .right{display:none;}
      .hamburger{display:flex;}
      .menu.menu-open{display:flex;position:fixed;inset:0;flex-direction:column;align-items:center;justify-content:center;background:#0b0b0fef;backdrop-filter:blur(8px);z-index:1000;padding:20px;gap:8px;}
      .menu .chip{width:80%;max-width:300px;justify-content:center;padding:12px;font-size:16px;}
    }

    /* Toast */
    .toast{position:fixed;left:50%;top:24px;transform:translateX(-50%) translateY(-20px);background:#000000bb;color:var(--fg);padding:8px 12px;border:1px solid #ffffff22;border-radius:10px;opacity:0;transition:all .3s ease;pointer-events:auto;z-index:1002;}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}

    /* Help modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1001;}
    .modal .back{position:absolute;inset:0;background:#00000090;backdrop-filter:blur(3px)}
    .modal .card{position:relative;max-width:720px;width:calc(100% - 40px);background:#0b0f12ee;border:1px solid #ffffff22;border-radius:16px;padding:18px 18px 14px 18px;box-shadow:0 10px 40px #000000aa}
    .modal h1{margin:0 0 8px 0;font-size:16px;letter-spacing:.08em;text-transform:lowercase}
    .modal p{margin:6px 0;color:#d6d6d6}
    .modal kbd{background:#11161a;border:1px solid #ffffff22;border-bottom-color:#000000;box-shadow:inset 0 -1px 0 #00000030;border-radius:6px;padding:2px 6px;margin:0 2px}
    .modal .hint{opacity:.75}
    .hidden{display:none}

    /* Panels */
    .panel{position:fixed;top:60px;left:18px;min-width:220px;max-width:280px;background:#0a0d10dd;border:1px solid #ffffff22;border-radius:12px;padding:10px;backdrop-filter:blur(5px);display:none;pointer-events:auto}
    .panel h3{margin:0 0 8px 0;font-size:12px;letter-spacing:.08em;text-transform:lowercase;color:#bcd}
    .row{display:flex;gap:6px;align-items:center;margin:6px 0}
    .row input[type="text"]{flex:1;background:#0f1418;border:1px solid #223;border-radius:8px;color:#cfe;padding:6px}
    .list{max-height:200px;overflow:auto}
    .list .itm{display:flex;gap:6px;align-items:center;justify-content:space-between;border:1px solid #ffffff14;background:#0b1014;border-radius:8px;padding:6px;margin:6px 0}
    .list .itm button{border:1px solid #ffffff20;background:#00000040;color:#dfe;padding:4px 6px;border-radius:8px;cursor:pointer}

    footer{position:fixed;bottom:4px;left:4px;font-size:11px;opacity:.6}

    /* Show fk readout only inside Lab */
    #fkread{display:none!important}
    #lab #fkread{display:inline!important}
  </style>
</head>
<body>
  <canvas id="c" aria-hidden="true"></canvas>

  <div class="overlay">
    <div class="brand" id="logo" title="click for help / hold to peek">
      <!-- EXACT inline SVG you provided (kept 1:1) -->
      <svg viewBox="0 0 300 432" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <g transform="translate(0,432) scale(0.1,-0.1)" fill="currentColor" stroke="none">
          <path d="M2294 4271 c-106 -26 -361 -249 -510 -446 -165 -217 -283 -458 -325 -662 -18 -85 1 -183 53 -281 78 -150 81 -234 11 -422 -90 -241 -220 -407 -461 -588 -76 -58 -132 -109 -149 -135 -15 -23 -29 -44 -31 -47 -2 -2 -8 2 -13 10 -13 18 -5 285 16 578 9 114 20 270 25 347 6 77 18 173 26 213 33 150 6 272 -60 280 -46 6 -67 -23 -65 -87 1 -31 -3 -87 -9 -126 -6 -38 -12 -90 -12 -114 0 -63 -59 -167 -147 -261 -124 -132 -252 -200 -377 -200 -81 0 -96 15 -103 102 -11 129 52 331 192 625 130 272 213 397 443 676 50 60 82 117 82 147 0 30 -35 60 -71 60 -25 0 -42 -11 -81 -52 -50 -53 -237 -327 -318 -467 -59 -102 -179 -346 -228 -461 -106 -255 -126 -330 -127 -480 0 -97 3 -122 22 -162 75 -163 312 -150 544 28 57 44 139 129 139 145 0 5 5 9 11 9 6 0 8 -8 5 -17 -8 -27 -26 -444 -28 -638 -1 -182 4 -213 45 -240 33 -21 106 -21 148 0 45 23 193 139 298 234 195 175 336 393 414 636 28 88 31 114 32 215 l0 115 -49 105 c-43 93 -49 112 -48 171 1 221 180 573 422 832 94 101 231 209 246 194 2 -2 0 -17 -6 -33 -5 -16 -25 -139 -45 -274 -35 -246 -78 -450 -199 -960 -37 -151 -80 -335 -98 -409 -24 -102 -39 -146 -65 -183 -36 -55 -41 -83 -18 -114 8 -12 13 -23 11 -25 -3 -2 -18 -64 -35 -137 -19 -82 -55 -195 -95 -295 -106 -267 -163 -464 -173 -593 -7 -102 1 -145 34 -185 22 -26 31 -30 57 -25 56 11 101 72 124 166 12 48 31 167 57 345 34 236 54 319 111 461 31 76 58 140 59 142 4 5 135 -196 174 -268 120 -223 169 -483 142 -750 -14 -132 -34 -239 -62 -325 -32 -95 -132 -296 -173 -344 -59 -70 -61 -78 -27 -96 36 -18 49 -19 33 -3 -19 19 -15 30 29 89 47 63 127 223 163 324 89 254 102 608 30 855 -43 151 -96 265 -189 405 -115 173 -138 168 -224 -51 -45 -114 -64 -200 -100 -449 -48 -329 -73 -416 -127 -452 -35 -22 -55 -9 -71 48 -33 111 28 355 185 749 63 159 106 343 98 421 -6 51 -4 60 29 114 19 32 35 65 35 73 0 8 16 78 35 156 83 340 167 697 209 891 47 221 120 696 111 726 -17 54 -101 16 -226 -104 -209 -199 -378 -461 -456 -707 -29 -93 -37 -131 -37 -200 -1 -79 2 -91 41 -175 56 -124 67 -166 59 -250 -16 -176 -95 -373 -225 -560 -97 -140 -349..."/>
          <path d="M473 2995 c-12 -8 -27 -31 -33 -49 -20 -63 25 -117 98 -116 72 1 109 98 57 154 -28 30 -87 36 -122 11z m106 -53 c11 -21 -2 -58 -26 -70 -43 -22 -97 33 -74 76 19 36 79 33 100 -6z"/>
        </g>
      </svg>
      <span class="wordmark">ask.report</span>
    </div>

    <div class="right" id="buttons">
      <button id="mode" class="chip" title="Switch mode [m]"><span class="kbd">mode</span></button>
      <button id="seedbtn" class="chip" title="Show current seed [d]"><span class="kbd">seed</span></button>
      <button id="copybtn" class="chip" title="Copy share link [c]"><span class="kbd">share</span></button>
      <button id="recbtn" class="chip" title="record video+audio [r]"><span class="kbd">record</span></button>
      <button id="wavbtn" class="chip" title="export wav [w]"><span class="kbd">wav</span></button>
      <label class="chip" title="speed [ [ / ] ]"><span class="kbd">speed</span>
        <input id="speed" class="range" type="range" min="-3" max="3" step="0.05" value="1"/>
      </label>
      <button id="helpbtn" class="chip" title="hold to show help [h]">?</button>
      <button id="labbtn" class="chip" title="lab: lock cycle / novelty / set f,k">lab</button>
      <button id="bmbtn" class="chip" title="bookmark [b] & library [l]"><span class="kbd">★</span></button>
    </div>

    <div class="hamburger" id="hamburger" title="menu">
      <div></div><div></div><div></div>
    </div>

    <div class="menu" id="menu" role="menu" aria-label="controls">
      <!-- Mobile buttons will be a duplicate set -->
      <button id="mode-m" class="chip" title="Switch mode [m]"><span class="kbd">mode</span></button>
      <button id="seedbtn-m" class="chip" title="Show current seed [d]"><span class="kbd">seed</span></button>
      <button id="copybtn-m" class="chip" title="Copy share link [c]"><span class="kbd">share</span></button>
      <button id="recbtn-m" class="chip" title="record video+audio [r]"><span class="kbd">record</span></button>
      <button id="wavbtn-m" class="chip" title="export wav [w]"><span class="kbd">wav</span></button>
      <label class="chip" title="speed [ [ / ] ]"><span class="kbd">speed</span>
        <input id="speed-m" class="range" type="range" min="-3" max="3" step="0.05" value="1"/>
      </label>
      <button id="helpbtn-m" class="chip" title="hold to show help [h]">?</button>
      <button id="labbtn-m" class="chip" title="lab: lock cycle / novelty / set f,k">lab</button>
      <button id="bmbtn-m" class="chip" title="bookmark [b] & library [l]"><span class="kbd">★</span></button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Library -->
  <div class="panel" id="lib">
    <h3>bookmarks</h3>
    <div class="row">
      <input id="bmname" type="text" placeholder="note (optional)"/>
      <button id="savebm">save</button>
    </div>
    <div class="list" id="bmlist"></div>
  </div>

  <!-- Lab -->
  <div class="panel" id="lab" style="display:none">
    <h3>lab mode</h3>
    <div class="row"><label><input type="checkbox" id="labLock"> lock cyclic_6</label></div>
    <div class="row"><label><input type="checkbox" id="labNovel" checked> novelty kicks</label></div>
    <div class="row">
      <label style="min-width:16px">f</label>
      <input id="labF" type="number" step="0.001" min="0.020" max="0.080" value="0.034" style="width:90px">
      <label style="min-width:16px">k</label>
      <input id="labK" type="number" step="0.001" min="0.040" max="0.070" value="0.062" style="width:90px">
    </div>
    <div class="row"><span id="fkread" style="opacity:.8">f=0.034, k=0.062</span></div>
  </div>

  <!-- Help -->
  <div class="modal" id="help" aria-modal="true" role="dialog">
    <div class="back"></div>
    <div class="card">
      <h1>chimera garden — a living sketch</h1>
      <p class="hint">reaction–diffusion (gray–scott) with cyclical modulation & novelty kicks. bytebeat hum keeps time. those who know their salts and cycles may notice a wink. ☿︎</p>
      <p><strong>interact</strong>: click/tap to inject disturbance; move to guide currents; wheel nudges phase.</p>
      <p><strong>controls</strong>:
        <br><kbd>m</kbd> mode • <kbd>s</kbd> reseed • <kbd>d</kbd> show seed • <kbd>c</kbd> copy link • <kbd>[</kbd>/<kbd>]</kbd> speed ± • <kbd>space</kbd> pause • <kbd>p</kbd> snapshot • <kbd>a</kbd> start audio • <kbd>r</kbd> record • <kbd>w</kbd> export wav • <kbd>b</kbd> bookmark • <kbd>l</kbd> library • <kbd>6</kbd> unlock advanced • <kbd>h</kbd> hold help
      </p>
      <p><strong>about</strong>: six-phase cadence steers feed/kill (our little <em>opus circulatorium</em>). when patterns settle, entropy declines and we perturb the vessel. seeds in the address bar preserve a world.</p>
      <p><strong>lab</strong>: click <em>lab</em> to lock/unlock cyclic_6, toggle novelty, and (when locked) set <code>f</code>/<code>k</code>. Live readout reflects current values.</p>
    </div>
  </div>

  <script>
  // === UI JAVASCRIPT ===
  (function(){
    // Mobile hamburger menu
    const hamburger = document.getElementById('hamburger');
    const menu = document.getElementById('menu');
    hamburger.addEventListener('click', (e) => {
      e.stopPropagation();
      menu.classList.toggle('menu-open');
    });
    menu.addEventListener('click', (e) => {
      if (e.target.closest('.chip')) {
        menu.classList.remove('menu-open');
      }
    });

    // Help Modal
    const helpModal = document.getElementById('help');
    const logo = document.getElementById('logo');
    function showHelp() { helpModal.style.display = 'flex'; }
    function hideHelp() { helpModal.style.display = 'none'; }

    logo.onclick = showHelp;
    document.querySelector('#help .back').addEventListener('click', hideHelp);
    document.addEventListener('keyup', e => { if (e.key === 'h') { hideHelp(); } });
  })();

  // === SIMULATION CORE ===
  (function(){
    const canvas = document.getElementById('c');
    const gl = canvas.getContext('webgl',{antialias:false,preserveDrawingBuffer:false});
    const DPR = Math.min(2, window.devicePixelRatio||1);
    function resize(){canvas.width=innerWidth*DPR;canvas.height=innerHeight*DPR;canvas.style.width='100%';canvas.style.height='100%';if(gl)gl.viewport(0,0,canvas.width,canvas.height)}
    addEventListener('resize',resize,{passive:true});

    let tSec=0, start=performance.now(), lastTime=start, speedFactor=1.0, prev=0, cur=0, next=1, probeTimer=0, phaseOffset=0;

    let mouse={x:0.5,y:0.5,down:false};
    function setMouse(e){const r=canvas.getBoundingClientRect();mouse.x=(e.clientX-r.left)/r.width;mouse.y=1-(e.clientY-r.top)/r.height;}
    canvas.addEventListener('pointermove',e=>setMouse(e),{passive:true});
    canvas.addEventListener('pointerdown',e=>{setMouse(e);mouse.down=true;kick=1.0;e.preventDefault();});
    canvas.addEventListener('pointerup',()=>{mouse.down=false;});
    canvas.addEventListener('wheel',e=>{phaseOffset+=Math.sign(e.deltaY)*0.02;e.preventDefault();},{passive:false});

    const fract=x=>x-Math.floor(x);

    function strSeed(s){let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=(h*16777619)>>>0;}return h>>>0}
    function parseHash(){const h=(location.hash||'').slice(1);if(!h)return null;const n=parseInt(h,36);return Number.isFinite(n)?(n>>>0):strSeed(h);}
    let seedVal=parseHash(); if(seedVal==null){seedVal=(Math.random()*0xffffffff)>>>0;location.hash=seedVal.toString(36);}
    function rng(){seedVal^=seedVal<<13;seedVal^=seedVal>>>17;seedVal^=seedVal<<5;return (seedVal>>>0)/4294967296;}

    const toastEl=document.getElementById('toast'); let toastTimer=null;
    function toast(msg){toastEl.textContent=msg;toastEl.classList.add('show');clearTimeout(toastTimer);toastTimer=setTimeout(()=>toastEl.classList.remove('show'),1600);}

    if(!gl){const ctx=canvas.getContext('2d');let t=0;resize();(function loop(){t+=0.005*Math.abs(speedFactor);resize();const w=canvas.width,h=canvas.height;const g=ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,Math.hypot(w,h)/1.2);g.addColorStop(0,`hsl(${(t*99)%360} 80% 60% / .6)`);g.addColorStop(1,'#000');ctx.fillStyle=g;ctx.fillRect(0,0,w,h);requestAnimationFrame(loop)})();return;}

    function sh(type,src){const s=gl.createShader(type);gl.shaderSource(s,src);gl.compileShader(s);if(!gl.getShaderParameter(s,gl.COMPILE_STATUS))throw gl.getShaderInfoLog(s);return s}
    function pr(vs,fs){const p=gl.createProgram();gl.attachShader(p,vs);gl.attachShader(p,fs);gl.linkProgram(p);if(!gl.getProgramParameter(p,gl.LINK_STATUS))throw gl.getProgramInfoLog(p);return p}
    const quad=(()=>{const b=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,b);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,3,-1,-1,3]),gl.STATIC_DRAW);return b})();
    function bindQuad(loc){gl.bindBuffer(gl.ARRAY_BUFFER,quad);gl.enableVertexAttribArray(loc);gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0)}

    const vSimple='attribute vec2 p;void main(){gl_Position=vec4(p,0.,1.);}';
    const fAnalytic=`precision highp float;uniform vec2 r;uniform float t;mat2 rot(float a){float c=cos(a),s=sin(a);return mat2(c,-s,s,c);}vec3 pal(float h){return .6+.4*cos(6.2831*(vec3(.0,.33,.67)+h));}
    void main(){vec2 uv=(gl_FragCoord.xy-.5*r)/min(r.x,r.y);vec2 z=uv*rot(t*0.07);float acc=0.;for(int i=0;i<80;i++){z=abs(z);z=z*rot(1.2)+vec2(.11,.07);float d=dot(z,z);acc+=exp(-4.0*d);z*=1.2+0.03*sin(t*0.6+float(i)*0.15);}float h=fract(acc*0.1+t*0.03+atan(uv.y,uv.x)/6.2831);vec3 col=pal(h);float v=clamp(acc*0.9,0.0,1.0);gl_FragColor=vec4(col*v,1.0);} `;
    const progA=pr(sh(gl.VERTEX_SHADER,vSimple),sh(gl.FRAGMENT_SHADER,fAnalytic));
    const aPosA=gl.getAttribLocation(progA,'p'); const uRa=gl.getUniformLocation(progA,'r'); const uTa=gl.getUniformLocation(progA,'t');

    const fSeed=`precision highp float;uniform vec2 r;uniform float t;uniform float s;float n(vec2 p){return fract(sin(dot(p,vec2(41.3,289.1))+s)*43758.5453);}void main(){vec2 uv=gl_FragCoord.xy/r; float U=1.0, V=0.0; float d=distance(uv,vec2(.5)); if(d<0.10) V=0.6 + 0.4*n(uv*vec2(r)); if(n(uv*vec2(r*1.3))>0.996) V=1.0; gl_FragColor=vec4(U,V,0.,1.);} `;
    const fStep=`precision highp float;uniform sampler2D prev;uniform vec2 r;uniform float t;uniform vec2 fv;uniform float kick;uniform vec2 mp;vec2 px(){return 1.0/r;}vec2 lap(vec2 uv){vec2 e=px(); vec2 c=texture2D(prev,uv).xy; vec2 s=texture2D(prev,uv+vec2(0.,-e.y)).xy; vec2 n=texture2D(prev,uv+vec2(0., e.y)).xy; vec2 w=texture2D(prev,uv+vec2(-e.x,0.)).xy; vec2 e2=texture2D(prev,uv+vec2( e.x,0.)).xy; return (s+n+w+e2 - 4.0*c);}void main(){vec2 uv=gl_FragCoord.xy/r; vec2 c=texture2D(prev,uv).xy; float U=c.x, V=c.y; vec2 L=lap(uv); float Du=0.16, Dv=0.08; float f=fv.x, k=fv.y; float uvv=U*V*V; U += (Du*L.x - uvv + f*(1.0-U)); V += (Dv*L.y + uvv - (f+k)*V); float d=dot(uv-mp,uv-mp); float bump=exp(-d*200.0)*kick; V=clamp(V + bump*0.35,0.0,1.0); U=clamp(U,0.0,1.0); gl_FragColor=vec4(U,V,0.0,1.0);} `;
    const fShow=`precision highp float;uniform sampler2D tex;uniform vec2 r;uniform float t;uniform float novelty;vec3 pal(float h){return .6+.4*cos(6.2831*(vec3(0.,.33,.67)+h));}
    void main(){vec2 uv=gl_FragCoord.xy/r; vec2 s=texture2D(tex,uv).xy; float h=fract(s.y*1.3 + s.x*0.7 + t*0.02 + novelty*0.15); vec3 col=pal(h); col*= smoothstep(0.0,1.0,s.x)*1.25; gl_FragColor=vec4(col,1.0);} `;
    const progSeed=pr(sh(gl.VERTEX_SHADER,vSimple),sh(gl.FRAGMENT_SHADER,fSeed));
    const progStep=pr(sh(gl.VERTEX_SHADER,vSimple),sh(gl.FRAGMENT_SHADER,fStep));
    const progShow=pr(sh(gl.VERTEX_SHADER,vSimple),sh(gl.FRAGMENT_SHADER,fShow));

    let lab={locked:false,novelty:true,f:0.034,k:0.062};
    function getFV(){ return (lab&&lab.locked)?[lab.f,lab.k]:cyclic6(tSec); }

    function makeTex(){const t=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,t);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);return t}
    const fb=[gl.createFramebuffer(),gl.createFramebuffer()], tex=[makeTex(),makeTex()];
    const probeFB=gl.createFramebuffer(), probeTex=makeTex(); const PROBE_W=48, PROBE_H=27;

    let accentHue=200/360;
    function rgbToHsl(r,g,b){const max=Math.max(r,g,b),min=Math.min(r,g,b);let h=0,s=0,l=(max+min)/2;if(max!==min){const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}h/=6;}return[h,s,l]}
    function updateAccentFromProbe(){
      const N=PROBE_W*PROBE_H; const bins=new Float32Array(36);
      for(let i=0;i<N;i++){ const o=i*4; const r=PROBE_BUF[o]/255,g=PROBE_BUF[o+1]/255,b=PROBE_BUF[o+2]/255; const [h,s,l]=rgbToHsl(r,g,b); if(!Number.isFinite(h)) continue; if(s>0.2 && l>0.15 && l<0.85){const bi=(Math.floor(h*36))%36;bins[bi]+=s*s;}}
      let best=-1,idx=0;for(let i=0;i<36;i++){if(bins[i]>best){best=bins[i];idx=i}}
      const domHue=idx/36; accentHue=(domHue+0.5)%1;
      const hdeg=Math.round(accentHue*360);
      document.documentElement.style.setProperty('--accent',`hsl(${hdeg} 95% 62%)`);
      document.documentElement.style.setProperty('--glow',  `hsl(${hdeg} 100% 60% / 0.55)`);
    }

    function alloc(){
      for(let i=0;i<2;i++){gl.bindTexture(gl.TEXTURE_2D,tex[i]);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,canvas.width,canvas.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindFramebuffer(gl.FRAMEBUFFER,fb[i]);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,tex[i],0);}
      gl.bindTexture(gl.TEXTURE_2D,probeTex);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,PROBE_W,PROBE_H,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindFramebuffer(gl.FRAMEBUFFER,probeFB);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,probeTex,0);gl.bindFramebuffer(gl.FRAMEBUFFER,null)
    }

    function cyclic6(time){const period=48.0;let x=(time%period)/period+phaseOffset;let phase=Math.floor(fract(x)*6.0);let u=fract(x*6.0);u=u*u*(3.0-2.0*u);
      const pairs=[[0.034,0.062],[0.038,0.061],[0.030,0.060],[0.045,0.064],[0.026,0.055],[0.040,0.066]];
      const a=pairs[phase],b=pairs[(phase+1)%6];return [a[0]*(1-u)+b[0]*u,a[1]*(1-u)+b[1]*u]}

    let lastProbe=null,stagnation=0,novelty=0;const PROBE_BUF=new Uint8Array(PROBE_W*PROBE_H*4);
    function measureNovelty(){gl.bindFramebuffer(gl.FRAMEBUFFER,probeFB);
      gl.useProgram(progShow);bindQuad(gl.getAttribLocation(progShow,'p'));gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,tex[cur]);gl.uniform1i(gl.getUniformLocation(progShow,'tex'),0);gl.uniform2f(gl.getUniformLocation(progShow,'r'),PROBE_W,PROBE_H);gl.uniform1f(gl.getUniformLocation(progShow,'t'),tSec);gl.uniform1f(gl.getUniformLocation(progShow,'novelty'),novelty);
      gl.viewport(0,0,PROBE_W,PROBE_H);gl.drawArrays(gl.TRIANGLES,0,3);gl.readPixels(0,0,PROBE_W,PROBE_H,gl.RGBA,gl.UNSIGNED_BYTE,PROBE_BUF);
      gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,canvas.width,canvas.height);
      const bins=new Uint32Array(32);let diff=0,N=PROBE_W*PROBE_H;
      for(let i=0;i<N;i++){const o=i*4;const lum=(PROBE_BUF[o]*3+PROBE_BUF[o+1]*6+PROBE_BUF[o+2])/10|0;const b=lum>>3;bins[b]++;if(lastProbe){const d=Math.abs(lum-lastProbe[i])|0;diff+=d;}}
      if(!lastProbe){lastProbe=new Uint8Array(N);for(let i=0;i<N;i++){const o=i*4;lastProbe[i]=(PROBE_BUF[o]*3+PROBE_BUF[o+1]*6+PROBE_BUF[o+2])/10|0;}return(novelty=1.0);}
      for(let i=0;i<N;i++){const o=i*4;lastProbe[i]=(PROBE_BUF[o]*3+PROBE_BUF[o+1]*6+PROBE_BUF[o+2])/10|0;}
      let ent=0;for(let i=0;i<32;i++){if(bins[i]){const p=bins[i]/N;ent-=p*Math.log(p);}}
      ent/=Math.log(32.0);diff/=(N*255.0);const score=.6*ent+.4*diff;novelty=score;
      if(score<0.08){stagnation++;}else{stagnation=0;} if(stagnation>6&&lab.novelty){disturb();stagnation=0;} return score;
    }

    let kick=0.0; function disturb(){kick=1.0;gl.useProgram(progSeed);bindQuad(gl.getAttribLocation(progSeed,'p'));
      gl.uniform2f(gl.getUniformLocation(progSeed,'r'),canvas.width,canvas.height);
      gl.uniform1f(gl.getUniformLocation(progSeed,'t'),tSec);
      gl.uniform1f(gl.getUniformLocation(progSeed,'s'),seedVal/4294967296);
      gl.bindFramebuffer(gl.FRAMEBUFFER,fb[next]);gl.drawArrays(gl.TRIANGLES,0,3);gl.bindFramebuffer(gl.FRAMEBUFFER,null);}

    const HIST=N=>Array.from({length:N},()=>({tex:makeTex(),fb:gl.createFramebuffer()}));
    const HISTORY=HIST(240);let histHead=0,histCount=0,rewind=false;
    function initHistory(){for(const h of HISTORY){gl.bindTexture(gl.TEXTURE_2D,h.tex);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,canvas.width,canvas.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindFramebuffer(gl.FRAMEBUFFER,h.fb);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,h.tex,0);}gl.bindFramebuffer(gl.FRAMEBUFFER,null)}
    function copyToHistory(srcTex){const h=HISTORY[histHead];gl.bindFramebuffer(gl.FRAMEBUFFER,h.fb);gl.useProgram(progShow);bindQuad(gl.getAttribLocation(progShow,'p'));gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,srcTex);gl.uniform1i(gl.getUniformLocation(progShow,'tex'),0);gl.uniform2f(gl.getUniformLocation(progShow,'r'),canvas.width,canvas.height);gl.uniform1f(gl.getUniformLocation(progShow,'t'),tSec);gl.uniform1f(gl.getUniformLocation(progShow,'novelty'),novelty);gl.drawArrays(gl.TRIANGLES,0,3);gl.bindFramebuffer(gl.FRAMEBUFFER,null);histHead=(histHead+1)%HISTORY.length;histCount=Math.min(histCount+1,HISTORY.length);}
    function showHistoryBack(step){if(histCount===0)return false;histHead=(histHead-step+HISTORY.length)%HISTORY.length;const idx=(histHead-1+HISTORY.length)%HISTORY.length;const h=HISTORY[idx];gl.useProgram(progShow);bindQuad(gl.getAttribLocation(progShow,'p'));gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,h.tex);gl.uniform1i(gl.getUniformLocation(progShow,'tex'),0);gl.uniform2f(gl.getUniformLocation(progShow,'r'),canvas.width,canvas.height);gl.uniform1f(gl.getUniformLocation(progShow,'t'),tSec);gl.uniform1f(gl.getUniformLocation(progShow,'novelty'),novelty);gl.drawArrays(gl.TRIANGLES,0,3);return true;}

    let mode=1,paused=false,seededOnce=false;
    function reseed(){seedVal=(Math.random()*0xffffffff)>>>0;location.hash=seedVal.toString(36);kick=1.0;seededOnce=true;seed();toast('new seed #'+seedVal.toString(36));}
    function showSeed(){toast('seed #'+seedVal.toString(36));}
    async function copyShare(){try{await navigator.clipboard.writeText(location.href);toast('link copied')}catch(e){prompt('Copy share link:',location.href)}}

    const libEl=document.getElementById('lib'),bmlist=document.getElementById('bmlist'),bmname=document.getElementById('bmname');
    function getLib(){try{return JSON.parse(localStorage.getItem('askreport_bm')||'[]')}catch(e){return[]}}
    function setLib(v){localStorage.setItem('askreport_bm',JSON.stringify(v))}
    function saveBookmark(){const list=getLib();list.unshift({seed:seedVal,speed:speedFactor,mode,note:bmname.value||'',t:Date.now()});setLib(list);bmname.value='';renderLib();toast('bookmarked');}
    function loadBookmark(bm){seedVal=bm.seed>>>0;location.hash=seedVal.toString(36);speedFactor=bm.speed;mode=bm.mode;toast('loaded #'+seedVal.toString(36));}
    function renderLib(){const list=getLib();bmlist.innerHTML='';list.forEach((bm,idx)=>{const div=document.createElement('div');div.className='itm';const left=document.createElement('div');left.textContent=`#${(bm.seed>>>0).toString(36)} ×${bm.speed.toFixed(2)} ${bm.mode?'rec':'ana'}`;const note=document.createElement('div');note.textContent=bm.note||'';note.style.opacity='.7';note.style.fontSize='12px';left.appendChild(document.createElement('br'));left.appendChild(note);const go=document.createElement('button');go.textContent='load';go.onclick=()=>loadBookmark(bm);const del=document.createElement('button');del.textContent='del';del.onclick=()=>{const list=getLib();list.splice(idx,1);setLib(list);renderLib();};div.appendChild(left);const r=document.createElement('div');r.appendChild(go);r.appendChild(del);div.appendChild(r);bmlist.appendChild(div);});}

    const labFEl=document.getElementById('labF'),labKEl=document.getElementById('labK'),fkRead=document.getElementById('fkread');
    function clamp(v,min,max){return v<min?min:(v>max?max:v)}
    labFEl.oninput=()=>{lab.f=clamp(parseFloat(labFEl.value)||0.034,0.020,0.080);fkRead.textContent=`f=${lab.f.toFixed(3)}, k=${lab.k.toFixed(3)}`;};
    labKEl.oninput=()=>{lab.k=clamp(parseFloat(labKEl.value)||0.062,0.040,0.070);fkRead.textContent=`f=${lab.f.toFixed(3)}, k=${lab.k.toFixed(3)}`;};
    function syncLabInputs(){const dis=!lab.locked;labFEl.disabled=dis;labKEl.disabled=dis;document.getElementById('labLock').checked=lab.locked;document.getElementById('labNovel').checked=lab.novelty;const fv=getFV();fkRead.textContent=`f=${fv[0].toFixed(3)}, k=${fv[1].toFixed(3)}`;}
    setInterval(syncLabInputs,300);

    function setBrandGlowCenter(){
      const brand=document.getElementById('logo'); if(!brand) return;
      const rect=brand.getBoundingClientRect();
      const icon=brand.querySelector('svg'); const label=brand.querySelector('.wordmark');
      if(!icon||!label) return;
      const rI=icon.getBoundingClientRect(), rL=label.getBoundingClientRect();
      const gx=(rI.right+rL.left)/2, gy=(Math.min(rI.top,rL.top)+Math.max(rI.bottom,rL.bottom))/2;
      const px=((gx-rect.left)/rect.width)*100, py=((gy-rect.top)/rect.height)*100;
      brand.style.setProperty('--brand-glow-x',px+'%'); brand.style.setProperty('--brand-glow-y',py+'%');
    }
    addEventListener('resize',setBrandGlowCenter,{passive:true});
    setTimeout(setBrandGlowCenter,0);

    function attach(i){gl.bindFramebuffer(gl.FRAMEBUFFER,fb[i]);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,tex[i],0);}
    function seed(){gl.useProgram(progSeed);bindQuad(gl.getAttribLocation(progSeed,'p'));gl.uniform2f(gl.getUniformLocation(progSeed,'r'),canvas.width,canvas.height);gl.uniform1f(gl.getUniformLocation(progSeed,'t'),tSec);gl.uniform1f(gl.getUniformLocation(progSeed,'s'),seedVal/4294967296);gl.bindFramebuffer(gl.FRAMEBUFFER,fb[0]);gl.drawArrays(gl.TRIANGLES,0,3);gl.bindFramebuffer(gl.FRAMEBUFFER,null)}
    function step(from,to){gl.useProgram(progStep);bindQuad(gl.getAttribLocation(progStep,'p'));gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,tex[from]);gl.uniform1i(gl.getUniformLocation(progStep,'prev'),0);gl.uniform2f(gl.getUniformLocation(progStep,'r'),canvas.width,canvas.height);const fv=getFV();gl.uniform2f(gl.getUniformLocation(progStep,'fv'),fv[0],fv[1]);gl.uniform1f(gl.getUniformLocation(progStep,'t'),tSec);gl.uniform1f(gl.getUniformLocation(progStep,'kick'),kick);gl.uniform2f(gl.getUniformLocation(progStep,'mp'),mouse.x,mouse.y);attach(to);gl.drawArrays(gl.TRIANGLES,0,3);gl.bindFramebuffer(gl.FRAMEBUFFER,null);kick*=mouse.down?0.95:0.90;}
    function show(idx){gl.useProgram(progShow);bindQuad(gl.getAttribLocation(progShow,'p'));gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,tex[idx]);gl.uniform1i(gl.getUniformLocation(progShow,'tex'),0);gl.uniform2f(gl.getUniformLocation(progShow,'r'),canvas.width,canvas.height);gl.uniform1f(gl.getUniformLocation(progShow,'t'),tSec);gl.uniform1f(gl.getUniformLocation(progShow,'novelty'),novelty);gl.drawArrays(gl.TRIANGLES,0,3)}

    function snapshot(){const url=canvas.toDataURL('image/png');const a=document.createElement('a');a.href=url;a.download=`ask-report-${Date.now()}.png`;a.click();}

    let audioStarted=false,ac,spn,tAudio=0,analyser,anaBuf;
    function tryStartAudio(){if(audioStarted)return;audioStarted=true;ac=new (window.AudioContext||window.webkitAudioContext)();const node=ac.createScriptProcessor(2048,0,1);analyser=ac.createAnalyser();analyser.fftSize=1024;anaBuf=new Uint8Array(analyser.frequencyBinCount);
      node.onaudioprocess=e=>{const out=e.outputBuffer.getChannelData(0);for(let i=0;i<out.length;i++){const tt=(tAudio++);const phase=((tSec%48.0)/48.0);const melody=((seedVal>>>3)&7);const m=((tt>>10)+melody)&7;const x=(tt>>4)+(m*m+(phase*64.0))|0;const bb=((x*(x>>5|x>>8))>>(3+(seedVal&3)))&255;out[i]=(bb/255)*0.3-0.15;}};
      const src=ac.createScriptProcessor(2048,0,1);src.onaudioprocess=node.onaudioprocess;src.connect(analyser);analyser.connect(ac.destination);spn=src;}

    function bindControls(scope=document){
      scope.querySelector('#mode')?.addEventListener('click',()=>{mode^=1; tryStartAudio();});
      scope.querySelector('#seedbtn')?.addEventListener('click',showSeed);
      scope.querySelector('#copybtn')?.addEventListener('click',copyShare);
      scope.querySelector('#recbtn')?.addEventListener('click',()=>console.log('rec'));
      scope.querySelector('#wavbtn')?.addEventListener('click',()=>console.log('wav'));
      scope.querySelector('#bmbtn')?.addEventListener('click',()=>{libEl.style.display=(libEl.style.display==='block')?'none':'block';renderLib();});
      scope.querySelector('#helpbtn')?.addEventListener('mousedown',()=>showHelp(true));
      scope.querySelector('#helpbtn')?.addEventListener('mouseup',()=>hideHelp(true));
      scope.querySelector('#speed')?.addEventListener('input',e=>{speedFactor=parseFloat(e.target.value)||1;toast(`Speed: ${speedFactor.toFixed(2)}`);});
      scope.querySelector('#labbtn')?.addEventListener('click',()=>{labPanel.style.display=(labPanel.style.display!=='block')?'block':'none';});
      scope.querySelector('#labLock')?.addEventListener('change',()=>{lab.locked=!!this.checked;toast(lab.locked?'cyclic_6 locked':'cyclic_6 unlocked');});
      scope.querySelector('#labNovel')?.addEventListener('change',()=>{lab.novelty=!!this.checked;toast(lab.novelty?'novelty on':'novelty off');});

      scope.querySelector('#mode-m')?.addEventListener('click',()=>{mode^=1; tryStartAudio();});
      scope.querySelector('#seedbtn-m')?.addEventListener('click',showSeed);
      scope.querySelector('#copybtn-m')?.addEventListener('click',copyShare);
      scope.querySelector('#recbtn-m')?.addEventListener('click',()=>console.log('rec'));
      scope.querySelector('#wavbtn-m')?.addEventListener('click',()=>console.log('wav'));
      scope.querySelector('#bmbtn-m')?.addEventListener('click',()=>{libEl.style.display=(libEl.style.display==='block')?'none':'block';renderLib();});
      scope.querySelector('#helpbtn-m')?.addEventListener('click',()=>showHelp());
      scope.querySelector('#speed-m')?.addEventListener('input',e=>{speedFactor=parseFloat(e.target.value)||1;toast(`Speed: ${speedFactor.toFixed(2)}`);});
      scope.querySelector('#labbtn-m')?.addEventListener('click',()=>{labPanel.style.display=(labPanel.style.display!=='block')?'block':'none';});
    }
    bindControls(document);

    resize();alloc();initHistory();
    (function frame(){
      const now=performance.now();const dt=Math.min(0.1,(now-lastTime)/1000);lastTime=now;
      if(!paused){
        if(mode===0){tSec+=dt*speedFactor;gl.useProgram(progA);bindQuad(aPosA);gl.uniform2f(uRa,canvas.width,canvas.height);gl.uniform1f(uTa,tSec);gl.drawArrays(gl.TRIANGLES,0,3);}
        else{
          if(speedFactor>=0 && !rewind){tSec+=dt*speedFactor;step(cur,next);show(next);copyToHistory(tex[next]);let tmp=cur;cur=next;next=tmp;}
          else{const steps=Math.max(1,Math.floor(Math.abs(speedFactor*2)));showHistoryBack(steps);}
          probeTimer+=1;if(probeTimer%45===0){measureNovelty();updateAccentFromProbe();}
        }
      }
      requestAnimationFrame(frame);
    })();
  })();
</script>
  </script>

  <footer>© 2025 ask.report — <a href="https://www.gnu.org/licenses/gpl-3.0.html" target="_blank" rel="noopener">GPL-3.0-or-later</a></footer>
  <noscript>ask.report — JavaScript required for the generative placeholder.</noscript>
</body>
</html>
